# Microservice

Stephan Grider Course

## Note

#### DBはサービスごとに一つである

1. 各サービスは独立している

2. DBの構成やスキーマが突然変更になるかもしれない

3. いくつかのサービスの機能は異なるDBを用いた方がより効率的になる場合がある。

- いずれのサービスも各サービス専用のDBのみにアクセスする

- いずれのサービスも異なるサービスのDBへアクセスすることはない

- ではどうやってサービス間でデータを共有することになるのだろうか？

もしもDBがどのサービスからでもアクセスできるような物であった場合に、

DBに障害が発生したらすべてのサービスが機能を提供できなくなる（DBへアクセスできなくなる）

また、

サービスBがクラッシュしているときに、もしもサービスAもサービスBのDBへアクセスできるなんて状態だったら、サービスAもクラッシュすることになる


#### Communication strategy between services

*Not meaning in JS.*

独立したサービス間でどうやってデータを共有するのかの話。

たとえばサービスA,B,Cの各データが欲しいサービスDを追加するとする。

サービスDは当然ABCのDBへアクセスできない。

なのでサービスDは他のサービスへリクエストを送ることで欲しいデータを取得するとする。

同期通信する場合メリットデメリット:

- サービス間の依存関係を発生させてしまう
- 内部リクエストのいずれかが失敗すると、すべてのリクエストが失敗する
- 全てのリクエストは一番遅いリクエストの速度に合わせることになる
- 依存関係が強まる
- サービスDはDBが要らない

非同期通信の場合2通り：

1. 異なるサービス間で共通でアクセスできる何らかの共有物をアプリケーション全体に導入しようとする(event bus)

サービスDが直接必要なサービスへリクエスト送るのではなくて、アプリケーション全体でのリクエストを管理するevet busが全てのリクエストの代行を実行する話

- event busがクラッシュしたらおじゃん
- eventbusがクラッシュしないようにするなど負担大
- 理解が困難である
- (同期通信の場合のすべての欠点を有することになる)


ということでまず採用されない方法であるが、そういう方法もあるから知って桶とのこと

2. サービスDに専用のDBを用意する

問題は、いかにしてABCの情報をDへ引っ張っていくかという点でここを解決する


非同期通信のメリットデメリット:

- サービスDは他のサービスから独立している
- 高速である
- データが重複する、重複したDBを用意しなくてはならない
- ロジックが複雑になる

講義ではこの非同期通信の方法でマイクロサービスを構築していく。

## Summary of application

GOal:

1. マイクロサービスを味わう
2. ゼロから構築する

今回構築するアプリケーションを今後のテンプレートとして使うことなかれ。

(著作権とかというより、参考にならないという理由で)

作成するサービス:

- posts
- moderate
- query
- event-bus
- comments
- client

シンプルなアプリケーションの作成になるけれど

実際には複雑なものを作ることになる

たとえばコメントは特定の投稿内容に対してなされるので、

コメントサービスは投稿サービスの内容について知っている必要がある、など。

するとコメントサービスは投稿サービスに依存しているということになる。

## 27 リクエスト最小化戦略

講義の最初の小さなアプリケーションをひとまず作った。

アプリケーションにおいて、

すでに投稿済のpostに対するコメントを取得するために

各postに対して一つずつコメントを取得するためのリクエストが発生していた

今後、postが増えてきて例えば1000剣とかになったときに

1000回各投稿に対するコメントを取得するリクエストを送信することになって

大変な負荷がかかること間違いなし。

なのですべてのコメントを一つのリクエストで取得するようにする。

monolith pattern:

DB（サーバ）は一つなのでそのリクエストが来たらすべてのコメントを含むレスポンスを返すだけ

event-busを利用する方法をとる。

各サービスで何か起こったらそれを感知して関心を寄せているオブザーバ（サービス）へ通知し、

サービスはリクエストに応答してevent-busへ返し

event-busはリクエスト元へ結果を返す...

みたいな

pros & cons.

- queryサービスは依存関係なし
- queryサービスは圧倒的に高速である
- データが重複することになる
- 難解である

## 29 非同期イベントに関するFAQ

1. 新規のデータを追加しなくてはならなくなったときはいつも新規のサービスを用意しなくてはならないの？

No.

2. 各サービスが独立していなきゃいけない必要ある？

独立したサービスと信頼度の高さはmicroserviceを用いる第一の理由である

3. 難解なくせに得られる利益が少ないのだが？

このアーキテクチャを使用すると、いくつかの機能を簡単に追加できるようになります


## Event Bus

`event-bus/note.md`へ

#### Summary of Event Bus

たくさんの異なる実装方法が存在する

イベントを受信してリスナへ通知する

非同期通信をより簡単またはより困難にするさまざまな微妙な機能

Expressを使った独自のevent busを実装する

でも通常はOOSや製品版のevent busを使うのが一般的である
